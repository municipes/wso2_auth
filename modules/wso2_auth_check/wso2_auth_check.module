<?php

/**
 * @file
 * Primary module hooks for WSO2 Auth Check module.
 */

 use Drupal\Core\Routing\RouteMatchInterface;

 /**
  * Implements hook_help().
  */
 function wso2_auth_check_help($route_name, RouteMatchInterface $route_match) {
   switch ($route_name) {
     case 'help.page.wso2_auth_check':
       $output = '';
       $output .= '<h3>' . t('About') . '</h3>';
       $output .= '<p>' . t('WSO2 Auth Check verifica se un utente è già autenticato presso l\'IdP WSO2 e lo autentica automaticamente in Drupal.') . '</p>';
       return $output;
   }
 }

 /**
  * Implements hook_page_attachments().
  */
 function wso2_auth_check_page_attachments(array &$attachments) {
   // Verifica se l'utente è anonimo.
   if (\Drupal::currentUser()->isAnonymous()) {
     // Aggiungi la libreria JavaScript.
     $attachments['#attached']['library'][] = 'wso2_auth_check/auth_check';

     // Aggiungi le impostazioni necessarie per il JS.
     $config = \Drupal::config('wso2_auth_check.settings');
     $settings = [
       'idpUrl' => $config->get('idp_url') ?: 'https://id.055055.it:9443/oauth2/authorize',
       'clientId' => $config->get('client_id') ?: 'Silfi-Opencity',
       'redirectUri' => $config->get('redirect_uri') ?: \Drupal::request()->getSchemeAndHttpHost() . '/wso2-auth-callback',
       'loginPath' => $config->get('login_path') ?: '/wso2silfi/connect/cittadino',
     ];

     $attachments['#attached']['drupalSettings']['wso2AuthCheck'] = $settings;
   }
 }

 /**
  * Implements hook_theme().
  */
 function wso2_auth_check_theme() {
   return [
     'wso2_auth_iframe' => [
       'variables' => [
         'iframe_url' => NULL,
       ],
     ],
   ];
 }
